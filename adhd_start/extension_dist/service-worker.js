function s(e,c){const o=Date.now(),t=a=>chrome.alarms.create(`ci_${a}`,{when:o+a*60*1e3});(c||[]).forEach(a=>{const n=String(a).split("+"),r=parseInt(n[1],10)||5;t(r)}),chrome.alarms.create("endBlock",{when:o+(e||20)*60*1e3})}function i(e){chrome.tabs.query({active:!0,currentWindow:!0},c=>{const o=c[0];o&&o.id!=null&&chrome.tabs.sendMessage(o.id,{type:"END_BLOCK",source:"background",reason:e||"timer"})})}chrome.runtime.onMessage.addListener((e,c,o)=>{if(!(!e||typeof e.type!="string")){if(e.type==="PROXY_FETCH")return fetch(e.url,{method:e.method||"GET",headers:e.headers||{"Content-Type":"application/json"},body:e.body?JSON.stringify(e.body):null}).then(async t=>{const a=await t.text();try{const n=JSON.parse(a);o({ok:t.ok,status:t.status,data:n})}catch{o({ok:t.ok,status:t.status,data:a})}}).catch(t=>{o({ok:!1,error:t.toString()})}),!0;if(e.type==="START_BLOCK"&&(chrome.alarms.clearAll(()=>{s(e.minutes,e.checkIns)}),chrome.notifications.create({type:"basic",iconUrl:"icon48.png",title:"Focus started",message:`Block running for ${e.minutes} min`})),e.type==="END_BLOCK"&&(chrome.alarms.clearAll(),chrome.notifications.create({type:"basic",iconUrl:"icon48.png",title:"Focus ended",message:"You stopped the focus block."}),i(e.reason||"manual-stop")),e.type==="PROFILE_UPDATED"){const t=e.profile||{},a=t&&t.firstName&&t.lastName&&t.email&&t.school&&t.program&&t.expectedCompletion;chrome.action.setBadgeText({text:a?"P":""}),chrome.action.setBadgeBackgroundColor({color:a?"#10B981":"#00000000"})}}});chrome.alarms.onAlarm.addListener(e=>{e.name.startsWith("ci_")&&chrome.notifications.create({type:"basic",iconUrl:"icon48.png",title:"Check-in",message:"How's it going? Need a 30-sec tip?"}),e.name==="endBlock"&&(chrome.notifications.create({type:"basic",iconUrl:"icon48.png",title:"Time!",message:"2-min debrief: What worked? What to change next time?"}),i("timer"))});
